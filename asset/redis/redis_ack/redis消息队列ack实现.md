# åŸºäº redis çš„ list æ€ä¹ˆå®ç° ack åŠŸèƒ½

> ä¸ºä»€ä¹ˆéœ€è¦å®ç°è¿™ä¸ªåŠŸèƒ½â“
>
> æ€ä¹ˆå®ç°è¿™ä¸ªåŠŸèƒ½â“
>
> è¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç¼ºç‚¹â“
>
> è¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„æ–¹æ³•å—â“



## ä¸ºä»€ä¹ˆéœ€è¦å®ç°è¿™ä¸ªåŠŸèƒ½

> æ¯”å¦‚ä¸€ä¸ªå•†åŸç³»ç»Ÿ, è®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡æ˜¯åˆ†å¼€çš„, åœ¨æŠ¢è´­æ¨¡å—çš„å®ç°ä¸­ä½¿ç”¨æ¶ˆæ¯æ¥è¡¥å¿çš„æ–¹å¼(é€šè¿‡redisçš„list)æ¥ä¿®æ”¹å•†å“çš„åº“å­˜ã€‚ å¦‚æœåœ¨å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­, åº“å­˜æœåŠ¡å¼‚å¸¸é‡å¯äº†, å…¶ä¸­å°±æœ‰å¯èƒ½ä¸¢å¤±äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªæœ‰æ•ˆçš„æ¶ˆæ¯ã€‚ é‚£ä¹ˆå¯¹äºç³»ç»Ÿçš„é²æ£’æ€§æ¥è¯´éƒ½ä¸æ˜¯ä¸€ä¸ªè¾ƒå¥½çš„å®ç°ã€‚



ğŸŒ°ä¸­çš„æ¶ˆæ¯æ˜¯æ€ä¹ˆä¸¢çš„ï¼Ÿ è¿˜èƒ½æ¢å¤å›æ¥å—ï¼Ÿ

ç”±äº list çš„ pop æ˜¯ç›´æ¥å‘æ¶ˆæ¯ä¸¢å‡ºæ¥çš„, é‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹ä¸­ redis å°±ä¼šæŠŠæ•°æ®ä»æœåŠ¡å™¨ä¸­åˆ é™¤, æ‰€ä»¥ pop æ¶ˆæ¯å‡ºæ¥çš„æ—¶å€™, æœ¬è´¨ä¸Šæ¶ˆæ¯å°±å·²ç»ä»æœåŠ¡å™¨ä¸­åˆ é™¤äº†ã€‚ æ‰€ä»¥æ¶ˆæ¯æ˜¯ä¸èƒ½å¤Ÿä¿è¯æ¶ˆæ¯æ˜¯å¦å·²ç»è¢«æ¶ˆè´¹è¿‡çš„ã€‚



åŸºäºç³»ç»Ÿçš„å¯é æ€§æ¥è¯´, éœ€è¦åšæ¶ˆæ¯çš„ç¡®è®¤åŠŸèƒ½çš„



## æ€ä¹ˆå®ç°è¿™ä¸ªåŠŸèƒ½

<span style="color:red">redis æ˜¯é€šè¿‡è°ƒç”¨å‘½ä»¤æ¥å®ç°æ•°æ®çš„æ“ä½œçš„</span>ã€‚ 

æ‰€ä»¥æµç¨‹æ˜¯è¿™æ ·çš„ã€‚ 

```shell
128.0.0.2:6379>lpop list_key_name;
> value_is_ok;
127.0.0.1:6379> set random_key_name value_is_ok;
> ok
```

éœ€è¦å…ˆæŠŠå€¼æ‹¿å‡ºï¼Œ ç„¶åå†ç”¨å®¢æˆ·ç«¯è®¾ç½®å›å», é—®é¢˜æ˜¯å¦‚æœ `value_is_ok` å¯ä»¥é¡ºåˆ©è·å–å›æ¥, ä½†æ˜¯åœ¨è®¾ç½®å€¼çš„æ—¶å€™ å®¢æˆ·ç«¯å‡ºé”™äº†ã€‚ã€‚ã€‚ å—¯, ç¡®å®ä¸å¤ªå¯¹ã€‚ é‚£ä¹Ÿæ˜¯ä¼šä¸¢æ•°æ®çš„å•Š



æ€»è§‰å¾—é‚£é‡Œå‡ºäº†é—®é¢˜ï¼Œ ä½†æ˜¯åˆè¯´ä¸å‡ºæ¥ã€‚ã€‚ã€‚

ğŸ’¡  æ‰€ä»¥ï¼Œ éœ€è¦æŠŠè¿™ä¸ªæ“ä½œåœ¨ä¸€ä¸ªå‘½ä»¤ä¸­æ¥å®Œæˆã€‚ æ•…è€Œéœ€è¦ä½¿ç”¨ä¸Š lua æ¥å®ç°å€¼çš„ "å¤‡ä»½" åŠŸèƒ½ã€‚ æ‰€ä»¥è„šæœ¬éœ€è¦å®ŒæˆæŠŠå€¼å†² list ä¸­ pop å‡ºæ¥ï¼Œ ç„¶åè®¾ç½®åˆ°ä¸€ä¸ª string æˆ–è€… hash ä¸­ã€‚



##### æŠŠæ¶ˆæ¯ pop å‡ºé˜Ÿåˆ—ï¼Œ å¹¶æŠŠæ¶ˆæ¯æ‹·è´ä¸€ä»½åˆ° string

``` lua
-- å¤„ç†å®¢æˆ·ç«¯ä¼ å…¥çš„å‚æ•° ä¸€ä¸ªæ˜¯ list key, ä¸€ä¸ªæ˜¯ random_str_key ä¹Ÿå¯ä»¥æ˜¯åˆ†å¸ƒå¼ id, åæ­£ä¸é‡å¤å°±å¥½
local list_key = KEYS[1];
local random_str_key = KEYS[2];
local res = {};

local opt_value = redis.call('lpop', list_key);
-- æ“ä½œå¤±è´¥
if (not opt_value) then
    res[1] = 2;
    res[2] = random_str_key;
    res[3] = 'nil';
    return res;
end

redis.call('set', random_str_key, opt_value);
res[1] = 1;
res[2] = random_str_key;
res[3] = opt_value;

return res;
```



##### ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹å®Œæˆ

```lua
-- è¿™ä¸ªæ˜¯å®ç°æ¶ˆæ¯çš„ç¡®è®¤åŠŸèƒ½, ä¸»è¦å°±æ˜¯åˆ é™¤string
local random_str_key = KEYS[1];
return redis.call('del',random_str_key);
```



##### æ¶ˆæ¯æ¶ˆè´¹å‡ºé”™ï¼Œ éœ€è¦é‡æ–°æŠ•æ”¾ä¼šæ¶ˆæ¯é˜Ÿåˆ—

```lua
local list_key = KEYS[1];
local random_str_key = KEYS[2];
local res = {};

-- å…ˆæŠŠæ¶ˆæ¯è·å–å‡ºæ¥
local opt_value = redis.call('get', random_str_key);
-- åˆ é™¤æ¶ˆæ¯
redis.call('del', random_str_key);
-- é‡æ–°è¿”å›åˆ° list
redis.call('rpush', list_key, opt_value);

res[1] = 1;
res[2] = random_str_key;
res[3] = opt_value;
return res;
```



æ‰€ä»¥æ•´ä¸ªå°±ä¸‰ä¸ª `scripts`

```lua
local pullScript = "local list_key = KEYS[1]; local random_str_key = KEYS[2]; local res = {}; local opt_value = redis.call('lpop', list_key); if (not opt_value) then res[1] = 2; res[2] = random_str_key; res[3] = 'nil'; return res; end redis.call('set', random_str_key, opt_value); res[1] = 1; res[2] = random_str_key; res[3] = opt_value; return res;"

local ackScript ="local random_str_key = KEYS[1]; return redis.call('del',random_str_key);";



local cancelScript = "local list_key = KEYS[1]; local random_str_key = KEYS[2]; local res = {}; local opt_value = redis.call('get', random_str_key); redis.call('del', random_str_key); redis.call('rpush', list_key, opt_value); res[1] = 1; res[2] = random_str_key; res[3] = opt_value; return res;";


```



## è¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç¼ºç‚¹

è¿™ä¸ªæ–¹æ³•ç›®å‰æœ‰ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼Œ å°±æ˜¯å®¢æˆ·ç«¯å¦‚æœå´©æºƒçš„è¯ï¼Œ å®¢æˆ·ç«¯å°±æ²¡æœ‰èƒ½åŠ›æ“ä½œæ¶ˆæ¯äº†ï¼Œ é™¤éäººå·¥ä»‹å…¥

è¿˜æœ‰å°±æ˜¯ lpop æ–¹æ³•ä¼šæœ‰æ¶ˆæ¯ä¸æ˜¯é˜»å¡è¯»çš„, æ²¡æœ‰åŠæ³•åšåˆ°å“åº”å¼, æ‰€ä»¥éœ€è¦å®¢æˆ·ç«¯å»ä¸æ–­åœ°è½®è¯¢





## è¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„æ–¹æ³•å—

* éœ€è¦åšåˆ°å“åº”å¼çš„è¯, éœ€è¦åœ¨æ¶ˆæ¯æŠ•é€’çš„æ—¶å€™æ”¾å…¥ list çš„æ—¶å€™æ’å…¥ä¸€ä¸ªæ¶ˆæ¯çš„ id, å¹¶ä¸”å¤åˆ¶ä¸€ä»½åˆ° string é‡Œé¢å», æ¶ˆè´¹æ¶ˆæ¯ä¹‹åæŠŠå¯¹ç»“æœåˆ é™¤å°±å¥½, å–æ¶ˆçš„è¯, æŠŠå€¼é‡æ–°æŠ•æ”¾åˆ°list é‡Œé¢


æ±‚ä¸ªğŸ‘

[ç¤ºä¾‹ä»£ç ](./main.go) 

