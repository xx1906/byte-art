# CMPXCHGL æŒ‡ä»¤ä¸ cas/mutex 
> mutex æ€§èƒ½ä¸€å®šä¼šå¾ˆå·®å—ï¼Ÿ
> cas å’Œ mutex æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

æ·±åº¦æŒ–æ˜ mutex.Lock 

### æœ€å¸¸ç”¨çš„ mutex æ˜¯æ€ä¹ˆå®ç°çš„
```golang

package main

import "sync"

func main() {
    mu := sync.Mutex{}
    mu.Lock() 
    defer mu.Unlock()
    
}

```

å…¶ä¸­ `mu.Lock()` ä»£ç å¦‚æœæˆåŠŸè·å–åˆ°é”ï¼Œ ç›´æ¥è¿”å›, å¦‚æœæ²¡æœ‰è·å–åˆ°ğŸ”, åˆ™è¿›å…¥è‡ªæ—‹ã€‚å…¶ä¸­è·å–é”çš„ä»£ç 
```golang
// CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value.
// CompareAndSwapInt32å¯¹int32å€¼æ‰§è¡Œ**æ¯”è¾ƒ**å’Œ**äº¤æ¢**æ“ä½œã€‚
func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)
```
æ‰€ä»¥ `CompareAndSwapInt32` å¦‚å‡½æ•°åä¸€æ ·, è¿›è¡Œæ¯”è¾ƒå’Œäº¤æ¢ã€‚ å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä»£ç ä¸­å°±æ²¡æœ‰å…·ä½“çš„å®ç°äº†ï¼Œ ä»–çš„å®ç°å’Œç¡¬ä»¶å¹³å°æœ‰å…³çš„

æ‰€ä»¥éœ€è¦ä½¿ç”¨ç¼–è¯‘å·¥å…·æŠŠä»£ç ç¼–è¯‘ç„¶åæå–å‡ºæ±‡ç¼–ä»£ç ã€‚ ä¹Ÿå¯ä»¥ç¼–è¯‘ä¹‹åä½¿ç”¨ objdump å·¥å…·, 
> ä½ æ€ä¹ˆçŸ¥é“æ˜¯è¿‡æ»¤ `CMPXCHGL` æŒ‡ä»¤çš„å‘¢ï¼Ÿ ã€‚ã€‚ã€‚ã€‚ å…¶å®ç¼–è¯‘å·¥å…·ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„, å°±åƒ `unsafe.Pointer` å…·ä½“å®ç°çš„æ±‡ç¼–ä»£ç å°±æ²¡æœ‰åŠæ³•æå–å‡ºæ¥äº†ã€‚ã€‚ã€‚
```shell script
go tool compile -S main.go | grep -C 5 CMPXCHGL > cas_cmp.s
```

```asm
	0x0043 00067 (<unknown line number>)	NOP
	0x0043 00067 (main.go:6)	MOVQ	AX, CX
	0x0046 00070 ($GOROOT/src/sync/mutex.go:74)	XORL	AX, AX
	0x0048 00072 ($GOROOT/src/sync/mutex.go:74)	MOVL	$1, DX
	0x004d 00077 ($GOROOT/src/sync/mutex.go:74)	LOCK
	`0x004e 00078 ($GOROOT/src/sync/mutex.go:74)	CMPXCHGL	DX, (CX)`
	0x0051 00081 ($GOROOT/src/sync/mutex.go:74)	SETEQ	AL
	0x0054 00084 ($GOROOT/src/sync/mutex.go:74)	TESTB	AL, AL
	0x0056 00086 ($GOROOT/src/sync/mutex.go:74)	JEQ	134
	0x0058 00088 (main.go:9)	LEAQ	sync.(*Mutex).UnlockÂ·f(SB), AX
	0x005f 00095 (main.go:9)	MOVQ	AX, ""..autotmp_7+40(SP)

```

é‡ç‚¹å…³æ³¨ç¬¬å…­è¡Œçš„æ±‡ç¼–ä»£ç , `CMPXCHGL	DX, (CX)`  ä¹Ÿå¯æœä¸€ä¸‹ [itel CMPXCHG](https://www.intel.com/content/www/us/en/search.html?ws=text#q=cmpxchg&t=All)

### CMPXCHGL æŒ‡ä»¤è§£æ
> è¿™ä¸ªæŒ‡ä»¤äº†ä¸€ä¸ªæ“ä½œæ•°: EAXã€‚ æŒ‡ä»¤æ¯”è¾ƒ EAX çš„å€¼ä¸ DX çš„å€¼ï¼Œ å¦‚æœç›¸ç­‰, å°† CX çš„å€¼èµ‹å€¼ç»™ EAX, å¹¶ä¸”å°†æ ‡å¿—å¯„å­˜å™¨ ZF çš„æ ‡å¿—ä½è®¾ç½®ä¸º 1ã€‚ 
> å¦‚æœä¸ç›¸ç­‰, å°† DX èµ‹å€¼ç»™ EAX, å¹¶ä¸”å°†æ ‡å¿—å¯„å­˜å™¨ZFä½ç½®è®¾ç½®ä¸º0ã€‚
[æ ‡å¿—å¯„å­˜å™¨](https://baike.baidu.com/item/%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8) OF ä½ç½® = 1, è¡¨ç¤ºæº¢å‡ºï¼› ZF ä¸ºé›¶æ ‡å¿—(ä¸æ‡‚ç¡¬ä»¶è®¾è®¡); 

æ‰€ä»¥è¿™ä¸ªæŒ‡ä»¤çš„å¤§ç™½è¯å°±æ˜¯: 
```python
å¦‚æœ DX == AX:
    AX = (CX)
    ZF = 1
å¦åˆ™:   
    AX = DX
    ZF = 0 
```
**ä½†æ˜¯è¿™æ˜¯ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤, è€Œä¸æ˜¯å¤šæ¡æ±‡ç¼–æŒ‡ä»¤**.. è¿™ä¸ªæŒ‡ä»¤çš„çš„è®¾è®¡å°±æ˜¯ç”¨æ¥äº¤æ¢å¹¶ä¸”æ¯”è¾ƒä¸¤ä¸ªæ•°, å¹¶ä¸”éœ€è¦åœ¨åŒä¸€ä¸ªæŒ‡ä»¤ä¸­å®Œæˆ



å¦‚æœæ²¡æœ‰æŠ¢åˆ°ğŸ”çš„ goroutine å°±ä¼šè¿›å…¥è‡ªæ—‹çš„çŠ¶æ€



### éœ€è¦æ³¨æ„

golang çš„ mutex ä¸æ˜¯å¯é‡å…¥çš„ã€‚ å¦‚æœåœ¨åŒä¸€ä¸ª goroutine ä¸­è·å–åŒä¸€æŠŠğŸ”å°†ä¼šå¯¼è‡´æ­»é”çš„æƒ…å†µ

>  * äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œ å³åœ¨ä¸€æ®µæ—¶é—´å†…æŸèµ„æºä»…ä¸ºä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰ã€‚ å¦‚æœæ­¤æ—¶æœ‰å…¶ä»–çš„è¿›ç¨‹è¯·æ±‚è¯¥èµ„æºï¼Œ åˆ™è¯·æ±‚çš„è¿›ç¨‹åªèƒ½ç­‰å¾…ã€‚
>  * è¯·æ±‚ä¸ä¿æŒæ¡ä»¶: è¿›ç¨‹å·²ç»ä¿æŒäº†è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œ ä½†æœ‰æå‡ºäº†æ–°çš„èµ„æºçš„è¯·æ±‚ï¼Œ è¯¥èµ„æºå·²è¢«å…¶ä»–çš„è¿›ç¨‹é”å æœ‰ï¼Œ æ­¤æ—¶è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ï¼Œ ä½†æ˜¯å¯¹è‡ªå·±å·²ç»æˆ–åˆ™çš„èµ„æºä¿æŒä¸é‡Šæ”¾ã€‚
>  * ä¸å¯å‰¥å¤ºæ¡ä»¶: è¿›ç¨‹æ‰€è·å¾—çš„çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œæ¯•ä¹‹å‰ï¼Œ ä¸èƒ½è¢«å…¶ä»–çš„è¿›ç¨‹å¼ºè¡Œå¤ºèµ°ï¼Œ å³åªèƒ½æœ‰è·å¾—è¯¥èµ„æºçš„è¿›ç¨‹æ¥è‡ªå·±é‡Šæ”¾
>  * å¾ªç¯ç­‰å¾…: è‹¥å¹²è¿›ç¨‹é—´å½¢æˆæ”¶å°¾å‘é‡çš„å¾ªç¯ç­‰å¾…èµ„æºçš„å…³ç³»ã€‚

### å‚è€ƒ
[intel cmpxchg instruction](http://heather.cs.ucdavis.edu/~matloff/50/PLN/lock.pdf)